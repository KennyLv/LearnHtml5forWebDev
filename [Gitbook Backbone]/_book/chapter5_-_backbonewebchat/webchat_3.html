<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Webchat (3) 前端开发 | Backbone.js入门</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../chapter5_-_backbonewebchat/webchat_4.html" />
    
    
    <link rel="prev" href="../chapter5_-_backbonewebchat/webchat_2.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="5.3" data-basepath=".." data-revision="1422607915792">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="chapter1-backbonejs/README.html">
            
                
                    <a href="../chapter1-backbonejs/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Chapter1 - 初识backbone
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="chapter2_-_helloworld/README.html">
            
                
                    <a href="../chapter2_-_helloworld/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Chapter2 - HelloWorld
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="chapter3_-_backbonecomponent/README.html">
            
                
                    <a href="../chapter3_-_backbonecomponent/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Chapter3 - Backbone组件
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="chapter3_-_backbonecomponent/backbonemodel.html">
            
                
                    <a href="../chapter3_-_backbonecomponent/backbonemodel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         Backbone中的Model
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1.1" data-path="chapter3_-_backbonecomponent/backbone__data_validation.html">
            
                
                    <a href="../chapter3_-_backbonecomponent/backbone__data_validation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.1.</b>
                        
                         Backbone 数据验证 Data Validation
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="chapter3_-_backbonecomponent/backbonecollection.html">
            
                
                    <a href="../chapter3_-_backbonecomponent/backbonecollection.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         Backbone中的Collection
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.3" data-path="chapter3_-_backbonecomponent/backbonerouter.html">
            
                
                    <a href="../chapter3_-_backbonecomponent/backbonerouter.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                         Backbone中的Router
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4" data-path="chapter3_-_backbonecomponent/backboneview.html">
            
                
                    <a href="../chapter3_-_backbonecomponent/backboneview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                         Backbone中的View
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="chapter4_-_backbonetodos/README.html">
            
                
                    <a href="../chapter4_-_backbonetodos/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Chapter4 - Backbone实例之TODOS
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="chapter5_-_backbonewebchat/README.html">
            
                
                    <a href="../chapter5_-_backbonewebchat/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Chapter5 - Backbone实战之Webchat
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="5.1" data-path="chapter5_-_backbonewebchat/webchat_1.html">
            
                
                    <a href="../chapter5_-_backbonewebchat/webchat_1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                         Webchat (1) 功能分析
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.2" data-path="chapter5_-_backbonewebchat/webchat_2.html">
            
                
                    <a href="../chapter5_-_backbonewebchat/webchat_2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                         Webchat (2) 详细设计
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="5.3" data-path="chapter5_-_backbonewebchat/webchat_3.html">
            
                
                    <a href="../chapter5_-_backbonewebchat/webchat_3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                         Webchat (3) 前端开发
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.4" data-path="chapter5_-_backbonewebchat/webchat_4.html">
            
                
                    <a href="../chapter5_-_backbonewebchat/webchat_4.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                         Webchat (4) 后端开发
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="chapter6_-_summary/README.html">
            
                
                    <a href="../chapter6_-_summary/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         Chapter6 - Summary总结
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="6.1" data-path="chapter6_-_summary/reference.html">
            
                
                    <a href="../chapter6_-_summary/reference.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.1.</b>
                        
                         Reference 参考
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6.2" data-path="chapter6_-_summary/appendix_-.html">
            
                
                    <a href="../chapter6_-_summary/appendix_-.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.2.</b>
                        
                         Appendix - 附录
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Backbone.js入门</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_257">
                    
                        <h1 id="webchat-3-">Webchat (3) 前端开发</h1>
<p>有了前面功能介绍以及整体详细设计 ，下面的开发就变得更有目的性了。
沿着上一篇文章的思路，我们先来把javascript模板建立起来，模板用来取代上一篇中html代码里的：</p>
<pre><code>&lt;li&gt;
    &lt;div class=&quot;msgtitle&quot;&gt;the5fire 2012-04-10 23:16:00&lt;/div&gt;
    &lt;p&gt;大家好！&lt;/p&gt;
&lt;/li&gt;
</code></pre><p>把它改成模板为：</p>
<pre><code>&lt;script type=&quot;text/template&quot; id=&quot;item-template&quot;&gt;

   &lt;div class=&quot;msgtitle&quot;&gt;
      &lt;%=username %&gt; &lt;%=date %&gt;&lt;a id=&quot;destroy&quot;&gt;删除&lt;/a&gt;
   &lt;/div&gt;
   &lt;p&gt;&lt;%=content %&gt;&lt;/p&gt;

&lt;/script&gt;
</code></pre><p>其实模板的作用就是复用，里面多了一个删除的连接，主要是为了演示backbone的DELETE操作。
模板建立很容易，下面来建立页面端的实体类，这个更容易，因为上篇文章已经分析好了：</p>
<pre><code>var Chat = Backbone.Model.extend({

    urlRoot:&#39;&#39;,
    defualts: {
        content:&#39;&#39;,
        username:&#39;&#39;,
        date:&#39;&#39;
    },
    clear: function(){
        this.destroy();
    }
});
</code></pre><p>没有看到我上一篇插曲文章的同学可能觉得奇怪，为什么urlRoot为空？这里再次重复一下，当model和collection一起使用的时候，或者更确切的说是一个model属于某一个collection时，collection的url将取代mode的urlRoot，但是你的urlRoot还必须存在。
顺着思路，在来看collection，其实简单的很，因为我这里的collection没有太多的动作要做：</p>
<pre><code>var ChatList = Backbone.Collection.extend({

    url:&#39;/chat/&#39;,

    model:Chat

});
</code></pre><p>仅此而已，是不是很简单。
然后同以前我们分析的todos一样，我们也来建立一个管理单个chat界面的类,学以致用，就是<code>&lt;strong&gt;</code>模仿--使用--发挥<code>&lt;/strong&gt;</code>：</p>
<pre><code>var ChatView = Backbone.View.extend({

    tagName:&#39;li&#39;,

    template:_.template($(&#39;#item-template&#39;).html()),
    events:{
        &#39;click #destroy&#39; : &#39;clear&#39;
    },

    initialize:function(){
        _.bindAll(this,&#39;render&#39;,&#39;remove&#39;);
        this.model.bind(&#39;change&#39;, this.render);
        this.model.bind(&#39;destroy&#39;, this.remove);
    },

    render: function(){
        $(this.el).html(this.template(this.model.toJSON()));
        return this;
    },

    clear: function(){
        this.model.clear();
    }
});
</code></pre><p>代码不肖多说。然后对应着，也要有一个整体的管理view：</p>
<pre><code>var AppView = Backbone.View.extend({
    el:$(&#39;.main&#39;),

    events: {
        &quot;click #send&quot;: &quot;say&quot;
    },

    initialize: function() {
        _.bindAll(this,&#39;addOne&#39;,&#39;addAll&#39;);
        this.nickname = this.$(&#39;#nickname&#39;);
        this.textarea = this.$(&quot;#content&quot;);

        chatList.bind(&#39;add&#39;, this.addOne);
        chatList.bind(&#39;reset&#39;, this.addAll);
        chatList.fetch();
        setInterval(function() {
            chatList.fetch({add: true});
        }, 5000);
    },

    addOne: function(chat) {
        //页面所有的数据都来源于server端，如果不是server端的数据，不应添加到页面上
        if(!chat.isNew()) {
            var view = new ChatView({model:chat});
            this.$(&quot;.chat_list&quot;).append(view.render().el);
            $(&#39;#screen&#39;).scrollTop($(&quot;.chat_list&quot;).height() + 200);
        }
    },

    addAll: function() {
        chatList.each(this.addOne);
    },

    say: function(event) {
        chatList.create(this.newAttributes());
        //为了满足IE和FF以及chrome
        this.textarea.text(&#39;&#39;);
        this.textarea.val(&#39;&#39;);
        this.textarea.html(&#39;&#39;);

    },


    newAttributes: function() {

        var content = this.textarea.val();
        if (content == &#39;&#39;) {
            content = this.textarea.text();
        }

        return {
          content: content,
          username: this.nickname.val(),
          date: get_time()
        };
    }
});
</code></pre><p>其中有两个地方需要注意：</p>
<ol>
<li><code>$(&#39;#screen&#39;).scrollTop($(&quot;.chat_list&quot;).height() + 200);</code>这个是为了让那个显示聊天信息的窗口滚动条始终处于最下方。</li></li>
<li>``` setInterval(function() {<pre><code>     chatList.fetch({add: true});
</code></pre>}, 5000);```</li>
</ol>
<p>这个的意思就是，每隔5秒就到到服务器取一下数据，里面的add：true参数表示，每次取回数据之后都在原有数据上累加。
剩下需要说的就是，不用忘了初始化AppView，以及在ChatView定义的上方，实例化ChatList：</p>
<pre><code>var chatList = new ChatList;
//ChatView定义上方
var appView = new AppView;
</code></pre><p>到这里web端的代码就构建完毕了，从上面的实现可以发现，web端和server端的交互全部通过collection中定义的url:&#39;/chat/&#39;来完成的。所有的CRUD操作通过POST，GET，PUT，DELETE来完成。</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../chapter5_-_backbonewebchat/webchat_2.html" class="navigation navigation-prev " aria-label="Previous page: Webchat (2) 详细设计"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../chapter5_-_backbonewebchat/webchat_4.html" class="navigation navigation-next " aria-label="Next page: Webchat (4) 后端开发"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
