<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Section 1_4 Self NPM Service by CNPM | About NodeJs</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../chapter1_npm_registry_npm/section_1_5_node_update.html" />
    
    
    <link rel="prev" href="../chapter1_npm_registry_npm/section_1_3_npm_-_module_install.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="1.4" data-basepath=".." data-revision="1423721745546">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.1" data-path="section_0_1_whats_nodejs.html">
            
                
                    <a href="../section_0_1_whats_nodejs.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.</b>
                        
                         Section 0_1 What&#39;s NodeJs
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2" data-path="section_0_2_event-driven_programming.html">
            
                
                    <a href="../section_0_2_event-driven_programming.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.</b>
                        
                         Section 0_2 Event-Driven programming
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="chapter1_npm_registry_npm/README.html">
            
                
                    <a href="../chapter1_npm_registry_npm/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Chapter1 NPM Registry (NPM库)
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="chapter1_npm_registry_npm/section_1_1_most_popular_node_modules.html">
            
                
                    <a href="../chapter1_npm_registry_npm/section_1_1_most_popular_node_modules.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         Section 1_1 Most Popular Node Modules
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="chapter1_npm_registry_npm/section_1_2_self_deinfed_node_module.html">
            
                
                    <a href="../chapter1_npm_registry_npm/section_1_2_self_deinfed_node_module.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         Section 1_2 Self Deinfed Node Module
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.3" data-path="chapter1_npm_registry_npm/section_1_3_npm_-_module_install.html">
            
                
                    <a href="../chapter1_npm_registry_npm/section_1_3_npm_-_module_install.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         Section 1_3 NPM - Install Error
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="1.4" data-path="chapter1_npm_registry_npm/section_1_4_self_npm_service_by_cnpm.html">
            
                
                    <a href="../chapter1_npm_registry_npm/section_1_4_self_npm_service_by_cnpm.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         Section 1_4 Self NPM Service by CNPM
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="chapter1_npm_registry_npm/section_1_5_node_update.html">
            
                
                    <a href="../chapter1_npm_registry_npm/section_1_5_node_update.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         Section 1_5 Node Update
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="chapter2_hello_node/README.html">
            
                
                    <a href="../chapter2_hello_node/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Chapter2 Hello Node
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="chapter2_hello_node/section_2_1_socketio.html">
            
                
                    <a href="../chapter2_hello_node/section_2_1_socketio.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         Section 2_1 Socket.IO
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="chapter2_hello_node/scetion_2_2_connect_&amp;_express.html">
            
                
                    <a href="../chapter2_hello_node/scetion_2_2_connect_&amp;_express.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         Scetion 2_2 connect &amp; express简介
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="chapter3_reference/README.html">
            
                
                    <a href="../chapter3_reference/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Chapter3 Reference
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >About NodeJs</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_362">
                    
                        <h1 id="cnpmnpm">CNPM搭建私有的NPM服务</h1>
<blockquote>
<p>张丹(Conan), 程序员Java,R,PHP,Javascript</p>
<p>weibo：@Conan_Z</p>
<p>blog: <a href="http://blog.fens.me" target="_blank">http://blog.fens.me</a></p>
<p>email: bsspirit@gmail.com</p>
<p>转载自：<a href="http://blog.fens.me/nodejs-cnpm-npm/" target="_blank">http://blog.fens.me/nodejs-cnpm-npm/</a></p>
</blockquote>
<h2 id="">前言</h2>
<p>随着Nodejs开发的项目越来越多，Node项目管理就成了一个需要思考的问题了。如果所有项目都开源统一用 NPM 进行管理也没什么问题，但总有一些是我们不希望的完全开放的代码，作为企业是核心秘密保留在公司内部，这个时候就需要在公司内网也搭建一套 NPM 依赖管理系统。</p>
<p>CNPM正好就提供了这个功能。从Github上CNPM的主页看，CNPM由国内Alibaba团队开发维护。</p>
<h2 id="">目录</h2>
<p>CNPM是什么？
搭建CNPM的服务器
设置私有注册库的三种方法
CNPM的客户端使用</p>
<ol>
<li>CNPM是什么？</li>
</ol>
<p>CNPM 是一个Nodejs的库，致力于打造私有的 NPM 注册服务。当然，除了私有库功能以外，CNPM官网 (<a href="http://cnpmjs.org/" target="_blank">http://cnpmjs.org/</a>) 还提供了NPM同步的服务。</p>
<p>CNPM官方发布的架构图：</p>
<p><img src="../cnpm-architect.png" alt="ss"></p>
<p>从CNPM的架构图中，我们可以看出CNPM是对NPM做的镜像服务，CNPM会定期同步NPM的资源库，同时CNPM支持发布私有的库，这样就非常方便地集成了公有库和私有库，对于公司内部的开发者来说，基本感觉不到两种库的区别。</p>
<p>另外，我们使用NPM下载依赖包时，经常性地会遇到一些包下载失败的情况，主要原因了NPM的注册服务器在国外，国内的网络环境访问国外的IP并不是太好。所以，直接配置到国内的NPM镜像，可以减少NPM下载出错机会。</p>
<p>比如，最近发生的NPM下载时的“No compatible version found”错误，如果不想升级NPM的环境，那么你还选择用CNPM去进行依赖管理，关于错误的详细介绍，请参考文章 NPM下载出错 No compatible version found</p>
<h3 id="cnpm">搭建CNPM的服务器</h3>
<p>从官方文档中，我们看到CNPM服务器环境，只需要Node(0.11.12) + MySQL(&gt;= 0.5.0)，另外我们还需要Linux的环境，接下来就让我们动手自己搭建一个私有NPM的服务器。</p>
<p>我的系统环境：</p>
<pre><code>Linux: Ubuntu 12.04.2 64bit Server
Node: v0.11.2
Npm: 1.2.21
MySQL: 5.6.11 MySQL Community Server (GPL)
IP: 192.168.1.20
</code></pre><p>通过github下载项目源代码</p>
<pre><code># 下载项目，进入目录

~ git clone https://github.com/cnpm/cnpmjs.org.git
~ cd cnpmjs.org
</code></pre><p>在我们开始安装依赖包之前，先要升级NPM的版本，不然会出现“No compatible version found”的错误。</p>
<pre><code>~ sudo npm install npm -g
/usr/local/bin/npm -&gt; /usr/local/lib/node_modules/npm/bin/npm-cli.js
npm@2.0.0-beta.0 /usr/local/lib/node_modules/npm
</code></pre><p>安装项目依赖</p>
<pre><code>
~ sudo npm install
npm WARN engine koa-generic-session@1.1.3: wanted: {&quot;node&quot;:&quot;&gt;= 0.11.9&quot;} (current: {&quot;node&quot;:&quot;0.11.2&quot;,&quot;np               m&quot;:&quot;2.0.0-beta.0&quot;})
npm WARN engine koa-redis@0.1.1: wanted: {&quot;node&quot;:&quot;&gt;= 0.11.9&quot;} (current: {&quot;node&quot;:&quot;0.11.2&quot;,&quot;npm&quot;:&quot;2.0.0-               beta.0&quot;})
npm WARN engine koa-resource-router@0.3.3: wanted: {&quot;node&quot;:&quot;&gt; 0.11.4&quot;} (current: {&quot;node&quot;:&quot;0.11.2&quot;,&quot;npm               &quot;:&quot;2.0.0-beta.0&quot;})
npm WARN engine koa-rt@0.0.2: wanted: {&quot;node&quot;:&quot;&gt;= 0.11.9&quot;} (current: {&quot;node&quot;:&quot;0.11.2&quot;,&quot;npm&quot;:&quot;2.0.0-bet               a.0&quot;})
npm WARN engine koa-router@3.2.3: wanted: {&quot;node&quot;:&quot;&gt; 0.11.4&quot;} (current: {&quot;node&quot;:&quot;0.11.2&quot;,&quot;npm&quot;:&quot;2.0.0-               beta.0&quot;})
npm WARN engine koa-static-cache@1.1.0: wanted: {&quot;node&quot;:&quot;&gt; 0.11.4&quot;} (current: {&quot;node&quot;:&quot;0.11.2&quot;,&quot;npm&quot;:&quot;               2.0.0-beta.0&quot;})
npm WARN deprecated lingo@0.0.5: This project is abandoned
co-read@0.1.0 node_modules/co-read

error-formater@1.0.3 node_modules/error-formater
└── utility@0.1.16 (address@0.0.3)

multiline@1.0.0 node_modules/multiline
└── strip-indent@1.0.0 (get-stdin@1.0.0)

jshint@2.5.5 node_modules/jshint
├── strip-json-comments@0.1.3
├── underscore@1.6.0
├── exit@0.1.2
├── shelljs@0.3.0
├── minimatch@0.4.0 (sigmund@1.0.0, lru-cache@2.5.0)
├── console-browserify@1.1.0 (date-now@0.1.4)
├── cli@0.6.4 (glob@3.2.11)
└── htmlparser2@3.7.3 (domelementtype@1.1.1, domutils@1.5.0, entities@1.0.0, domhandler@2.2.0, readabl               e-stream@1.1.13)

koa-middlewares@1.2.0 node_modules/koa-middlewares
├── koa-conditional-get@1.0.2
├── koa-rt@0.0.2
├── koa-session@2.0.0
├── koa-etag@1.3.1 (buffer-crc32@0.2.3)
├── koa-logger@1.2.2 (passthrough-counter@0.0.1)
├── koa-compress@1.0.7 (statuses@1.0.4, koa-is-json@1.0.0, compressible@1.1.1)
├── koa-safe-jsonp@0.2.0 (jsonp-body@0.1.0)
├── koa-rewrite@1.1.0 (path-to-regexp@0.0.2)
├── koa-static-cache@1.1.0 (fs-readdir-recursive@0.0.2, compressible@1.1.1, mime-types@1.0.2)
├── koa-redis@0.1.1 (redis@0.10.3)
├── koa-router@3.2.3 (koa-compose@2.3.0, methods@1.1.0, path-to-regexp@0.2.1)
├── koa-bodyparser@1.0.1 (co-body@1.0.0)
├── koa-favicon@1.1.0 (co-fs@1.2.0)
├── koa-resource-router@0.3.3 (koa-compose@2.2.0, path-to-regexp@0.0.2, debug@0.7.4, lingo@0.0.5, defa               ults@1.0.0)
├── koa-generic-session@1.1.3 (buffer-crc32@0.2.3, uid-safe@1.0.1)
├── koa-csrf@2.1.3 (csrf@2.0.1)
├── koa-ejs@1.0.1 (ejs@1.0.0, co-fs@1.2.0, is-type-of@0.2.1)
└── koa-onerror@1.0.3 (swig@1.4.2)
</code></pre><p>创建MySQL数据库，我本地的MySQL用户名为root，密码是mysql，可以通过下面语句创建。</p>
<pre><code>~ mysql -uroot -pmysql -e &#39;DROP DATABASE IF EXISTS cnpmjs_test;&#39; &amp;&amp;\
mysql -uroot -pmysql -e &#39;CREATE DATABASE cnpmjs_test;&#39; &amp;&amp;\
mysql -uroot -pmysql &#39;cnpmjs_test&#39; &lt; docs/db.sql &amp;&amp;\
mysql -uroot -pmysql &#39;cnpmjs_test&#39; -e &#39;show tables;&#39;
+-----------------------+
| Tables_in_cnpmjs_test |
+-----------------------+
| dist_dir              |
| dist_file             |
| download_total        |
| module                |
| module_deps           |
| module_keyword        |
| module_log            |
| module_maintainer     |
| module_star           |
| module_unpublished    |
| tag                   |
| total                 |
| user                  |
+-----------------------+
</code></pre><p>接下来，我们需要在项目的./config/index.js文件中，修改MySQL数据库的用户名和密码。</p>
<pre><code>~ vi ./config/index.js

108   /**
109    * mysql config
110    */
111
112   mysqlServers: [
113     {
114       host: &#39;127.0.0.1&#39;,
115       port: 3306,
116       user: &#39;root&#39;,
117       password: &#39;mysql&#39;
118     }
119   ],
120   mysqlDatabase: &#39;cnpmjs_test&#39;,
121   mysqlMaxConnections: 4,
122   mysqlQueryTimeout: 5000,
123
</code></pre><p><strong> 启动CNPM服务器 </strong></p>
<p>默认会打开两个端口，7001用于NPM的注册服务，7002用于Web访问。</p>
<pre><code>~  node --harmony_generators dispatch.js
[Tue Sep 02 2014 15:17:54 GMT+0800 (CST)] [worker:25211:common/redis.js] Redis config can not found
[Tue Sep 02 2014 15:17:54 GMT+0800 (CST)] [worker:25211] Server started, registry server listen at 127.0.0.1:7001, web listen at 127.0.0.1:7002, cluster: false
[Tue Sep 02 2014 15:17:54 GMT+0800 (CST)] [worker:25211] mysql ready, got 13 tables
</code></pre><p>从日志中看到，这两个端口服务都绑定在127.0.0.1的本地网络中，我们需要修改配置文件 ./config/index.js文件，注释bindingHost一行，对外网开放。</p>
<pre><code>~ vi ./config/index.js

 39   /*
 40    * server configure
 41    */
 42   registryPort: 7001,
 43   webPort: 7002,
 44   //bindingHost: &#39;127.0.0.1&#39;, // only binding on 127.0.0.1 for local access
</code></pre><p><strong> 第二次，启动CNPM服务器 </strong></p>
<pre><code>
~ node --harmony_generators dispatch.js
[Tue Sep 02 2014 15:22:46 GMT+0800 (CST)] [worker:25259:common/redis.js] Redis config can not found
[Tue Sep 02 2014 15:22:46 GMT+0800 (CST)] [worker:25259] Server started, registry server listen at undefined:7001, web listen at undefined:7002, cluster: false
[Tue Sep 02 2014 15:22:46 GMT+0800 (CST)] [worker:25259] mysql ready, got 13 tables
</code></pre><p>通过浏览器访问：<a href="http://192.168.1.20:7002" target="_blank">http://192.168.1.20:7002</a>  ，没想到的情况，应用又崩溃了，这个坑深入了！！</p>
<pre><code>
[Tue Sep 02 2014 15:29:00 GMT+0800 (CST)] [worker:25404] Server started, registry server listen at undefined:7001, web listen at undefined:7002, cluster: false
[Tue Sep 02 2014 15:29:00 GMT+0800 (CST)] [worker:25404] mysql ready, got 13 tables

==== JS stack trace =========================================

    2: arguments adaptor frame: 0-&gt;1
Security context: 0x185dd4b5e291 &lt;JS Object&gt;#0#
    4: /* anonymous */ [/home/conan/nodejs/cnpmjs.org/node_modules/co/index.js:40] (this=0x2a1e646d07e1 &lt;an Object&gt;#1#,done=0x2d36f5fcdd31 &lt;JS Function&gt;#2#)
    5: /* anonymous */ [/home/conan/nodejs/cnpmjs.org/node_modules/koa/lib/application.js:125] (this=0x2d36f5fab301 &lt;a Server&gt;#3#,req=0x2d36f5fcacc1 &lt;an IncomingMessage&gt;#4#,res=0x2d36f5fcc3f9 &lt;a ServerResponse&gt;#5#)
    6: emit [events.js:100] (this=0x2d36f5fab301 &lt;a Server&gt;#3#,type=0x8305a126379 &lt;String[7]: request&gt;)
    7: arguments adaptor frame: 3-&gt;1
    8: onIncoming [_http_server.js:450] (this=0x2d36f5fc8029 &lt;an HTTPParser&gt;#6#,req=0x2d36f5fcacc1 &lt;an IncomingMessage&gt;#4#,shouldKeepAlive=0x185dd4b04161 &lt;true&gt;)

//省略日志
</code></pre><p>经过检查发现，是Node版本的问题。重新下载编译安装Node，详细操作请参考文章准备Nodejs开发环境Ubuntu，升级后的版本为</p>
<pre><code>Node v0.13.0-pre
NPM 1.4.21
</code></pre><p><strong> 第三次，启动CNPM服务 </strong></p>
<pre><code>~ node --harmony_generators dispatch.js
[Tue Sep 02 2014 16:00:25 GMT+0800 (CST)] [worker:14842:common/redis.js] Redis config can not found
[Tue Sep 02 2014 16:00:25 GMT+0800 (CST)] [worker:14842] Server started, registry server listen at undefined:7001, web listen at undefined:7002, cluster: false
[Tue Sep 02 2014 16:00:25 GMT+0800 (CST)] [worker:14842] mysql ready, got 13 tables
</code></pre><p>通过浏览器访问，CNPM服务：<a href="http://192.168.1.20:7002" target="_blank">http://192.168.1.20:7002</a></p>
<p>终于正常了，这样就成功搭建了私有的NPM注册服务。</p>
<p>搜索一下，我之前在NPM发布的自己的包ape-algorithm，发现没有结果，根据界面提示CNPM应用会自动去NPM上同步。</p>
<p>第一次同步操作，会下载很多的包，大家要耐心等待啊。页面不能切换！</p>
<h3 id="">设置私有注册库的三种方法</h3>
<p>我们自己搭建的私有服务怎么用呢？</p>
<p>我们先建一个项目目录</p>
<pre><code>~ /home/conan/nodejs
~ mkdir nodejs-cnpm &amp;&amp; cd nodejs-cnpm
</code></pre><p><strong> 3.1 下载指定私有库 </strong></p>
<p>一种简单的方式就是，下载的时候指定我们自己的私有库，这样就会从我们自己的私有库中下载。如果私有库没有对应的库，CNPM会自动同步到NPM 找到我们要下载的库和版本，先在CNPM中存一份，然后再传给客户端一份，运行原理和Maven的原理一样。</p>
<p>执行下载的操作</p>
<pre><code>~ npm install ape-algorithm --registry=http://192.168.1.20:7001
ape-algorithm@0.0.8 node_modules/ape-algorithm
└── linklist@0.0.3

# 查看下载的库

~ ls -l
drwxrwxr-x 3 conan conan 4096  9月  2 16:36 node_modules
</code></pre><p><strong> 3.2 给项目设置私有库 </strong></p>
<p>如果这个项目所有依赖库都从公司内网下载，那么我们可以给整个项目设置私有库，就不需要每次下载的时候单独指定了。</p>
<p>首先，我们查看项目的默设置，通过npm config list命令。</p>
<pre><code>~ npm config list

; cli configs
registry = &quot;https://registry.npmjs.org/&quot;
user-agent = &quot;npm/1.4.21 node/v0.13.0-pre linux x64&quot;

; node bin location = /usr/local/bin/node
; cwd = /home/conan/nodejs/nodejs-cnpm
; HOME = /home/conan
; &#39;npm config ls -l&#39; to show all defaults.
</code></pre><p>registry属性是指向NPM的官司位置<a href="https://registry.npmjs.org/，我们可以通过npm" target="_blank">https://registry.npmjs.org/，我们可以通过npm</a> config set registry命令来修改这个配置。</p>
<pre><code>
~ npm config set registry http://192.168.1.20:7001

# 再次查看项目设置

~ npm config list
; cli configs
registry = &quot;http://192.168.1.20:7001/&quot;
user-agent = &quot;npm/1.4.21 node/v0.13.0-pre linux x64&quot;

; userconfig /home/conan/.npmrc
registry = &quot;http://192.168.1.20:7001/&quot;

; node bin location = /usr/local/bin/node
; cwd = /home/conan/nodejs/nodejs-cnpm
; HOME = /home/conan
</code></pre><p>这个项目再下载新包时，就会通过我们私有库去下载。</p>
<p><strong> 3.3 给用户设置私有库 </strong></p>
<p>如果我们的开发环境在内网，不允许访问外网，那么我们可以设置全局的NPM库。</p>
<p>在当前用户所在的根目录，找到.npmrc文件，配置NPM私有库。</p>
<p>~  vi ~/.npmrc</p>
<p>registry=<a href="http://192.168.1.20:7001" target="_blank">http://192.168.1.20:7001</a>
设置成功后，当前用户的所有NPM下载都会通过私有库来完成。</p>
<p><strong> 3.4 设置淘宝的开放库 </strong></p>
<p>我们除了使用自己的私有库，还可以使用淘宝的NPM库，这样可以有效地避免国内访问国外NPM库，网络不通的问题。</p>
<p>按照上面的方法，把registry配置为<a href="https://registry.npm.taobao.org" target="_blank">https://registry.npm.taobao.org</a> 就行了。</p>
<pre><code>registry = &quot;https://registry.npm.taobao.org/&quot;
</code></pre><h3 id="cnpm">CNPM的客户端使用</h3>
<p>CNPM 不仅提供服务端的功能，还提供了客户端的访问功能，就像NPM一样。通过全局安装cnpm包，可以完全取代了npm的命令操作了。</p>
<p><strong> 安装cnpm客户端 </strong></p>
<pre><code>~ sudo npm install -g cnpm

/usr/local/bin/cnpm -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm
/usr/local/bin/cnpm-sync -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm-sync
/usr/local/bin/cnpm-check -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm-check
/usr/local/bin/cnpm-web -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm-web
/usr/local/bin/cnpm-user -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm-user
/usr/local/bin/cnpm-doc -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm-doc
/usr/local/bin/cnpm-search -&gt; /usr/local/lib/node_modules/cnpm/bin/cnpm-search
cnpm@1.0.0 /usr/local/lib/node_modules/cnpm
├── commander@2.3.0
├── auto-correct@1.0.0
├── giturl@0.0.3
├── cross-spawn@0.1.7
├── colors@0.6.2
├── bagpipe@0.3.5
├── open@0.0.5
├── debug@1.0.4 (ms@0.6.2)
├── npm-request@0.0.4 (urllib@0.5.11)
├── npm@2.0.0-beta.2
└── urllib@0.5.17 (default-user-agent@0.0.1, debug@0.8.1, digest-header@0.0.1)
</code></pre><p><strong> 测试通过cnpm安装gulp包 </strong></p>
<pre><code>~ cnpm install gulp

&gt; node-v8-clone@0.6.2 install /home/conan/nodejs/nodejs-cnpm/node_modules/gulp/node_modules/gulp-util/node_modules/vinyl/node_modules/node-v8-clone
&gt; node-gyp rebuild

gulp@3.8.7 node_modules/gulp
├── tildify@0.2.0
├── interpret@0.3.2
├── pretty-hrtime@0.2.0
├── deprecated@0.0.1
├── archy@0.0.2
├── minimist@0.2.0
├── semver@3.0.1
├── chalk@0.5.0 (escape-string-regexp@1.0.1, ansi-styles@1.1.0, supports-color@0.2.0, has-ansi@0.1.0, strip-ansi@0.3.0)
├── orchestrator@0.3.0 (sequencify@0.0.7, events@1.0.2, execify@0.0.3)
├── liftoff@0.12.0 (extend@1.2.1, minimist@0.1.0, resolve@0.7.4, findup-sync@0.1.3)
├── gulp-util@3.0.1 (lodash._reinterpolate@2.4.1, dateformat@1.0.8-1.2.3, minimist@1.1.0, multipipe@0.1.0, lodash.template@2.4.1, through2@0.6.1, lodash@2.4.1, vinyl@0.4.0)
└── vinyl-fs@0.3.0 (map-stream@0.1.0, graceful-fs@3.0.2, lodash.defaults@2.4.1, mkdirp@0.5.0, through2@0.5.1, strip-bom@0.3.0, through2-map@1.4.0, glob-watcher@0.0.6, glob-stream@3.1.15, vinyl@0.2.0)
</code></pre><p>效果同NPM一样，gulp包被成功安装。</p>
<p>当我们要发布包到NPM的时候，由于CNPM默认同步时间差是30分钟，如果想马上同步，需要手动输入同步的命令。</p>
<p><strong> 同步gulp包 </strong></p>
<pre><code>
~ cnpm sync gulp

Start sync [&quot;gulp&quot;].
sync gulp, PUT http://r.cnpmjs.org/gulp/sync?publish=false&amp;nodeps=false
logurl: http://cnpmjs.org/sync/gulp#logid=10798
[2014-09-02 05:18:09] user: anonymous, sync gulp worker start, 1 concurrency, nodeps: false, publish: false
[2014-09-02 05:18:09] [c#0] [gulp] pkg status: 200, start...
[2014-09-02 05:18:09]   [gulp] found 15 missing star users
[2014-09-02 05:18:09]   [gulp] all versions are exists
[2014-09-02 05:18:09]   [gulp] no versions need to deleted
[2014-09-02 05:18:09]   [gulp] saving 15 star users
[2014-09-02 05:18:09]   [gulp] saving 3/187 missing npm users: [&quot;mittya&quot;,&quot;160mph&quot;,&quot;vivainio&quot;]
[2014-09-02 05:18:09] [c#0] [gulp] synced success, 0 versions:
[2014-09-02 05:18:09] [c#0] setImmediate after, gulp done, start next...
[2014-09-02 05:18:09] [done] Sync gulp module finished, 1 success, 0 fail
Success: [ gulp ]
Fail: [  ]
sync gulp, PUT https://registry.npm.taobao.org/gulp/sync?publish=false&amp;nodeps=false
logurl: https://npm.taobao.org/sync/gulp#logid=8354
[2014-09-02 17:18:13] user: anonymous, sync gulp worker start, 1 concurrency, nodeps: false, publish: false
[2014-09-02 17:18:14] [c#0] [gulp] pkg status: 200, start...
[2014-09-02 17:18:14]   [gulp] found 15 missing star users
[2014-09-02 17:18:14]   [gulp] all versions are exists
[2014-09-02 17:18:14]   [gulp] saving 15 star users
[2014-09-02 17:18:14]   [gulp] no versions need to deleted
[2014-09-02 17:18:15]   [gulp] saving 3/188 missing npm users: [&quot;mittya&quot;,&quot;160mph&quot;,&quot;vivainio&quot;]
[2014-09-02 17:18:15] [c#0] setImmediate after, gulp done, start next...
[2014-09-02 17:18:15] [c#0] [gulp] synced success, 0 versions:
[2014-09-02 17:18:15] [done] Sync gulp module finished, 1 success, 0 fail
Success: [ gulp ]
Fail: [  ]
Sync all packages done, successed: [&quot;gulp&quot;], failed: []
</code></pre><p>这样我们就完全地把CNPM私有库在公司内部用起来了。把包管理的问题解决了，让程序员可以踏踏实实地写代码才是最重要的！！</p>
<blockquote>
<p>Note :</p>
<ul>
<li>npm adduser admin 然后设置邮件为config里的admin邮件即可</li>
<li>如何将自己的包上传到私有库?
<a href="http://cnpmjs.org/" target="_blank">http://cnpmjs.org/</a>
$ cnpm publish [name]</li>
<li>我看官方说只有admin用户才能发布,怎么登录admin后发布?admin密码在哪里可以看?
直接给官方邮箱发信问吧。
整个项目都是开源的，第一可以去问，第二也可以看代码。</li>
<li>不支持搭建在windows下吗?</li>
<li>私有化仓库才是企业应用的第一步。</li>
</ul>
</blockquote>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../chapter1_npm_registry_npm/section_1_3_npm_-_module_install.html" class="navigation navigation-prev " aria-label="Previous page: Section 1_3 NPM - Install Error"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../chapter1_npm_registry_npm/section_1_5_node_update.html" class="navigation navigation-next " aria-label="Next page: Section 1_5 Node Update"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
